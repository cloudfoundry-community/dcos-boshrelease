#!/bin/bash

assure_string_in_file() {
  assurefilename=$1
  assuresearchString=$2
  assurereplaceString=$3

  if grep -q "$assuresearchString" "$assurefilename"; then
    re="s#^.*$assuresearchString.*#$assurereplaceString#"
    sed -i "${re}" "$assurefilename"
    (( "$?" == "0" )) ||
    echo "Could not execute execute sed command replace $assuresearchString with $assurereplaceString in file $assurefilename, terminating install."
  else
    echo "$assurereplaceString" >> "$assurefilename"
    (("$?" == "0")) ||
    echo "Unable to set $assuresearchString in $assurefilename, terminating install."
  fi
}



mkdir -p /var/vcap/store/opt
mkdir -p /var/vcap/store/mesos/master
mkdir -p /var/vcap/store/mesos/slave
mkdir -p /var/vcap/store/docker

if [ ! -L /opt ] ; then
  rm -rf /opt
fi

ln -sf /var/vcap/store/opt /opt

mkdir -p /etc/docker

echo '{"graph": "/var/vcap/store/docker"}' > /etc/docker/daemon.json

export PATH=$PATH:/usr/sbin

mkdir -p /var/vcap/data/ssh
cp /etc/ssh/* /var/vcap/data/ssh

touch /etc/selinux/config
bash /var/vcap/packages/dcos/install_prereqs.sh

echo "Configure docker store"
filename="/etc/systemd/system/docker.service.d/execstart.conf"
assure_string_in_file $filename "ExecStart=/usr/bin/dockerd" "ExecStart=/usr/bin/dockerd --storage-driver=overlay"

systemctl daemon-reload
systemctl start docker
cp /tmp/ssh/* /var/vcap/data/ssh


mkdir -p /opt/dcos_install_tmp
tar xf /var/vcap/packages/dcos/dcos-install.tar -C /opt/dcos_install_tmp

bash /opt/dcos_install_tmp/dcos_install.sh <%= p('type') %>

<% if p('type') == "master" %>
echo "Configure meso master common..."
  filename="/opt/mesosphere/etc/mesos-master"
  assure_string_in_file $filename "MESOS_WORK_DIR" "MESOS_WORK_DIR=/var/vcap/store/mesos/master"

systemctl restart dcos-mesos-master.service
<% else %>

echo "Configure meso slave common..."
  filename="/opt/mesosphere/etc/mesos-slave-common"
  assure_string_in_file $filename "MESOS_DOCKER_STORE_DIR" "MESOS_DOCKER_STORE_DIR=/var/vcap/store/mesos/slave/store/docker"
  assure_string_in_file $filename "MESOS_WORK_DIR" "MESOS_WORK_DIR=/var/vcap/store/mesos/slave"

systemctl restart dcos-mesos-slave.service

<% end %>